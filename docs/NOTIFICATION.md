# 任务执行结果通知功能

本系统支持在任务执行完成后发送通知，支持邮件、钉钉和企业微信三种通知方式。

## 功能特性

- ✅ 邮件通知（支持 SMTP 和 TLS）
- ✅ 钉钉机器人通知（支持签名验证和@功能）
- ✅ 企业微信机器人通知（支持@功能）
- ✅ 可配置通知时机（成功时通知、失败时通知）
- ✅ 支持多种通知方式同时使用
- ✅ 通知配置测试功能

## 配置说明

### 1. 邮件通知配置

在任务编辑界面的"通知配置"部分，选择"邮件通知"并填写以下信息：

- **SMTP服务器**: 邮件服务器地址（如：smtp.gmail.com）
- **SMTP端口**: 邮件服务器端口（如：587）
- **用户名**: 邮箱账号
- **密码**: 邮箱密码或应用专用密码
- **发件人**: 发件人邮箱地址
- **收件人**: 接收通知的邮箱地址（可多个）
- **邮件主题**: 自定义邮件主题（可选）
- **启用TLS**: 是否启用TLS加密

#### 常用邮箱配置示例

**Gmail:**
- SMTP服务器: smtp.gmail.com
- SMTP端口: 587
- 启用TLS: 是

**QQ邮箱:**
- SMTP服务器: smtp.qq.com
- SMTP端口: 587
- 启用TLS: 是

**163邮箱:**
- SMTP服务器: smtp.163.com
- SMTP端口: 25 或 465
- 启用TLS: 是（465端口）

### 2. 钉钉通知配置

1. 在钉钉群中添加"自定义机器人"
2. 获取 Webhook URL
3. 在任务配置中填写：
   - **Webhook URL**: 机器人的完整URL
   - **签名密钥**: 如果启用了签名验证，填写密钥（可选）
   - **@手机号**: 需要@的用户手机号（可选）
   - **@所有人**: 是否@所有人（可选）

### 3. 企业微信通知配置

1. 在企业微信群中添加"群机器人"
2. 获取 Webhook URL
3. 在任务配置中填写：
   - **Webhook URL**: 机器人的完整URL
   - **@用户ID**: 需要@的用户ID（可选）
   - **@所有人**: 是否@所有人（可选）

## 使用步骤

1. **创建或编辑任务**
   - 在任务管理页面点击"新建任务"或编辑现有任务

2. **配置通知时机**
   - 选择"执行成功时通知"和/或"执行失败时通知"

3. **选择通知方式**
   - 可以同时选择多种通知方式

4. **填写通知配置**
   - 根据选择的通知方式填写相应的配置信息

5. **测试通知**
   - 点击"测试通知"按钮验证配置是否正确

6. **保存任务**
   - 保存任务后，通知配置即生效

## 通知内容

通知消息包含以下信息：
- 任务名称
- 执行状态（成功/失败）
- 开始时间
- 结束时间
- 执行时长
- 执行输出（如果有）
- 错误信息（如果执行失败）

## 注意事项

1. **邮件通知**
   - 确保SMTP服务器配置正确
   - 某些邮箱需要开启"允许不够安全的应用"或使用应用专用密码
   - 建议使用TLS加密连接

2. **钉钉通知**
   - 确保机器人已正确添加到群中
   - 如果使用签名验证，确保密钥正确
   - @功能需要填写正确的手机号

3. **企业微信通知**
   - 确保机器人已正确添加到群中
   - @功能需要填写正确的用户ID

4. **通用注意事项**
   - 建议先使用"测试通知"功能验证配置
   - 通知发送失败不会影响任务的正常执行
   - 通知发送的日志会记录在系统日志中

## 故障排除

### 邮件通知发送失败
- 检查SMTP服务器地址和端口是否正确
- 检查用户名和密码是否正确
- 检查是否需要启用TLS
- 检查邮箱是否开启了SMTP服务

### 钉钉通知发送失败
- 检查Webhook URL是否正确
- 检查机器人是否被移除或禁用
- 如果使用签名验证，检查密钥是否正确

### 企业微信通知发送失败
- 检查Webhook URL是否正确
- 检查机器人是否被移除或禁用
- 检查网络连接是否正常

## API 接口

### 测试通知接口

```http
POST /api/v1/notifications/test
Authorization: Bearer <token>
Content-Type: application/json

{
  "notification_types": ["email", "dingtalk", "wechat"],
  "notification_config": {
    "email": {
      "smtp_host": "smtp.gmail.com",
      "smtp_port": 587,
      "username": "your-email@gmail.com",
      "password": "your-password",
      "from": "your-email@gmail.com",
      "to": ["recipient@example.com"],
      "enable_tls": true
    },
    "dingtalk": {
      "webhook_url": "https://oapi.dingtalk.com/robot/send?access_token=...",
      "secret": "your-secret"
    },
    "wechat": {
      "webhook_url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=..."
    }
  }
}
```

## 更新日志

- v1.0.0: 初始版本，支持邮件、钉钉、企业微信通知